<?php

function scdprimo_help($path, $arg) {
  switch ($path) {
    case "admin/help#scdprimo":
      return '<p>' . t("Help text") . '</p>';
      break;
  }
} 

function scdprimo_menu() {
  $items[] = array(
    'path' => 'primo-global',
    'title' => 'Rechercher',
    'page callback' => 'scdprimo_global',
    'access callback' => TRUE,
  );

  $items[] = array(
    'path' => 'primo-martinique',
    'title' => 'Rechercher',
    'page callback' => 'scdprimo_martinique',
    'access callback' => TRUE,
  );

  $items[] = array(
    'path' => 'primo-guadeloupe',
    'title' => 'Rechercher',
    'page callback' => 'scdprimo_guadeloupe',
    'access callback' => TRUE,
  );

  return $items;
}

function scdprimo_global() {
  return drupal_get_form('scdprimo_global_form');
}

function scdprimo_martinique() {
  return drupal_get_form('scdprimo_martinique_form');
}

function scdprimo_block_info() {
  $blocks['primo_martinique'] = array(
    'info' => t('Recherche Primo pour la Martinique'), 
    'cache' => DRUPAL_NO_CACHE,
  );

  $blocks['primo_guadeloupe'] = array(
    'info' => t('Recherche Primo pour la Guadeloupe'), 
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

function scdprimo_block_view($delta = '') {
  switch($delta) {
    case 'primo_martinique':
      $block['content'] = drupal_get_form('scdprimo_martinique_form');
      break;
    case 'primo_guadeloupe':
      $block['content'] = drupal_get_form('scdprimo_guadeloupe_form');
      break;
  }

  return $block;
}

function scdprimo_global_form($form_state) {
  $form['query'] = array(
    '#type' => 'textfield',
    '#title' => t('Search'),
    '#required' => TRUE,
  );

  $form['institution']  = array('#type' => 'hidden', '#value' => 'UAG',       );
  $form['vid']          = array('#type' => 'hidden', '#value' => 'UAG',       );
  $form['search_scope'] = array('#type' => 'hidden', '#value' => 'Blended'    );
  $form['tab']          = array('#type' => 'hidden', '#value' => 'default_tab');

  $form['types'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Filtrer par type'),
    '#options' => drupal_map_assoc(array(
      t('books'),
      t('articles'),
      t('reviews'),
      t('media'),
      t('other'),
    )),
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );

  return $form;
}

function scdprimo_global_form_submit($form, &$form_state) {
  $form_state['values']['query'] = 'any,contains,' . $form_state['values']['query'];
  $url = 'http://primo-33uag.hosted.exlibrisgroup.com/primo_library/libweb/action/dlSearch.do' .
    url(NULL, array(
      'query' => $form_state['values'],
      'external' => TRUE,
    ));

  foreach($form_state['values']['types'] as $k => $v) {
    if ($v)
      $url .= "&query=facet_rtype,exact," . $k;
  }

  drupal_goto($url); 
}

function scdprimo_library_form() {
  $form['institution']  = array('#type' => 'hidden', '#value' => 'UAG',       );
  $form['vid']          = array('#type' => 'hidden', '#value' => 'UAG',       );
  $form['search_scope'] = array('#type' => 'hidden', '#value' => 'UAG_HORIZON');
  $form['tab']          = array('#type' => 'hidden', '#value' => 'default_tab');

  $form['query'] = array(
    '#type' => 'textfield',
    '#title' => t('Search'),
    '#attributes' => array(
      'placeholder' => t('Trouvez des livres, revues, DVD, etc...'),
    ),
    '#theme_wrappers' => array(),
    '#prefix' => '<div class="input-group input-group-lg">',
    '#required' => TRUE,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => '<span class="glyphicon glyphicon-search visible-xs" aria-hidden="true"></span> <span class="hidden-xs">Chercher</span>',
    '#prefix' => '<span class="input-group-btn">',
    '#suffix' => '</span></div>',
  );

  return $form;
}

function scdprimo_martinique_form() {
  return scdprimo_library_form();
}

function scdprimo_guadeloupe_form() {
  return scdprimo_library_form();
}

function scdprimo_martinique_form_submit($form, &$form_state) {
  $form_state['values']['query'] = 'any,contains,' . $form_state['values']['query'];
  $url = 'http://primo-33uag.hosted.exlibrisgroup.com/primo_library/libweb/action/dlSearch.do' .
    url(NULL, array(
      'query' => $form_state['values'],
      'external' => TRUE,
    ));

  $url .= "query=facet_library,exact,BUMA";

  drupal_goto($url);
}

function scdprimo_guadeloupe_form_submit($form, &$form_state) {
  $form_state['values']['query'] = 'any,contains,' . $form_state['values']['query'];
  $url = 'http://primo-33uag.hosted.exlibrisgroup.com/primo_library/libweb/action/dlSearch.do' .
    url(NULL, array(
      'query' => $form_state['values'],
      'external' => TRUE,
    ));

  $url .= "query=facet_library,exact,BUGA";

  drupal_goto($url);
}

?>
